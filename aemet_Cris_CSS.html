<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mis predicciones</title>
    <link rel="stylesheet" href="/css/estilo_meteo (1).css" />
  </head>
  <body>
    <h1>La predicción del tiempo</h1>
    <div class="titulo">
      <label for="provincia">Provincia: </label>
      <select name="provincia" id="provincia">
        <option value="" disabled selected>Elige una provincia</option>
        <option value="48">Bizkaia</option>
        <option value="20">Gipuzkoa</option>
        <option value="01">Álava</option>
      </select>
      <select name="municipio" id="municipio"></select>
      <button type="button" id="peticion">Obtener datos</button>
    </div>
    <div class="contenedor-tablas" style="display: flex">
      <table id="temperaturas_hoy"></table>
      <table id="temperaturas_mañana"></table>
      <table id="temperaturas_pasado"></table>
    </div>
  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>
  <script>
    const obten_municipios = function (provincia) {
      fetch("./municipios.json")
        .then((response) => {
          if (!response.ok) {
            throw new Error("No se pudo cargar el archivo JSON");
          }
          return response.json();
        })
        .then((data) => {
          // console.log("Contenido de municipios.json:", data);
          let provincia_seleccionada =
            document.getElementById("provincia").value;
          let datos_provincia = data.filter(
            (m) => m.Provincia === provincia_seleccionada
          );
          selector_municipio = document.getElementById("municipio");
          selector_municipio.innerHTML = "";
          datos_provincia.forEach((municipio) => {
            // console.log(municipio.Municipio, municipio.Codigo);
            let opcion = document.createElement("option");
            opcion.innerText = municipio.Municipio;
            opcion.value = municipio.Codigo;
            selector_municipio.appendChild(opcion);
          });
          console.log("Contenido de la provincia:", datos_provincia);
        })
        .catch((error) => {
          console.error("Error al leer municipios.json:", error);
        });
    };

    const renderiza_temperaturas = function (temperaturas, dia) {
      let tabla_temp = document.getElementById(`temperaturas_${dia}`);
      tabla_temp.innerHTML = `<caption>
        Temperaturas esperadas para ${dia}
      </caption>
      <thead>
        <td>Hora</td>
        <td>Temperatura</td>
      </thead>
      <tbody class="cuerpo_tabla"></tbody>`;
      //cuerpoTabla = tabla_temp.querySelector(".cuerpo_tabla");
      cuerpoTabla = tabla_temp.getElementsByClassName("cuerpo_tabla")[0];
      temperaturas.forEach((momento) => {
        fila = document.createElement("tr");
        fila.innerHTML = `<td>${momento.periodo}</td><td>${momento.value}</td>`;
        cuerpoTabla.appendChild(fila);
      });
    };

    function generarPDFManana(municipio, temperaturasManana) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ format: 'a4' });

      doc.setFontSize(18);
      doc.text(`Predicción meteorológica para ${municipio}`, 15, 25);
      doc.setFontSize(14);
      doc.text('Temperaturas esperadas para mañana', 15, 40);

      // Prepara los datos para la tabla
      const tableColumn = ["Hora", "Temperatura"];
      const tableRows = temperaturasManana.map(item => [
        item.periodo,
        `${item.value}°C`
      ]);

      // Dibuja la tabla usando autoTable
      doc.autoTable({
        head: [tableColumn],
        body: tableRows,
        startY: 50,
        theme: 'grid',
        styles: { fontSize: 12 }
      });

      doc.save(`prediccion_manana_${municipio}.pdf`);
    }

    function generarPDF(municipio, temperaturasHoy) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(18);
      doc.text(`Predicción meteorológica para ${municipio}`, 10, 20);

      doc.setFontSize(12);
      doc.text("Hora   |   Temperatura", 10, 30);

      let y = 40;
      temperaturasHoy.forEach(item => {
        doc.text(`${item.periodo}   |   ${item.value}°C`, 10, y);
        y += 10;
      });

      doc.save(`prediccion_${municipio}.pdf`);
    }

    const hacer_peticion_api = function () {
      let codMunicipio = document.getElementById("municipio").value;
      console.log(codMunicipio);
      const apiKey =
        "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhaXRvci5kb25hZG9AZ21haWwuY29tIiwianRpIjoiOWVkNGFhYzQtNTI3YS00N2YzLTg5NzMtMTNlNGIxMTE4ZDUxIiwiaXNzIjoiQUVNRVQiLCJpYXQiOjE3MzU4MDY0NTYsInVzZXJJZCI6IjllZDRhYWM0LTUyN2EtNDdmMy04OTczLTEzZTRiMTExOGQ1MSIsInJvbGUiOiIifQ.vNGn79c-G44_Eu8MnrimYDDfHf0il9jILxXeBE2z1AE";
      let url = `https://opendata.aemet.es/opendata/api/prediccion/especifica/municipio/horaria/${codMunicipio}?api_key=${apiKey}`;

      fetch(url)
        .then((response) => {
          if (!response.ok) {
            throw new Error("Error en la respuesta: " + response.status);
          }
          return response.json();
        })
        .then((data) => {
          console.log("Datos recibidos de la API:", data);
          // La respuesta tiene una propiedad llamada 'datos' con la URL donde están los datos reales
          return fetch(data.datos);
        })
        .then((response) => response.json())
        .then((predicciones) => {
          console.log("Predicciones:", predicciones);
          let temperaturasHoy = predicciones[0].prediccion.dia[0].temperatura;
          renderiza_temperaturas(temperaturasHoy, "hoy");
          let temperaturasManana = predicciones[0].prediccion.dia[1].temperatura;
          renderiza_temperaturas(temperaturasManana, "mañana");
          let temperaturasPasado = predicciones[0].prediccion.dia[2].temperatura;
          renderiza_temperaturas(temperaturasPasado, "pasado");

          // Obtener el nombre del municipio seleccionado
          let municipioNombre = document.getElementById("municipio").selectedOptions[0].text;
          let btnPDF = document.getElementById("btnPDFManana");
          if (!btnPDF) {
            btnPDF = document.createElement("button");
            btnPDF.id = "btnPDFManana";
            btnPDF.textContent = "Descargar PDF de mañana";
            document.querySelector(".titulo").appendChild(btnPDF);
          }
          btnPDF.onclick = () => generarPDFManana(municipioNombre, temperaturasManana);
        })
        .catch((error) => {
          console.error("Hubo un error en la petición:", error);
        });
    };

    document
      .getElementById("provincia")
      .addEventListener("change", obten_municipios);

    document
      .getElementById("peticion")
      .addEventListener("click", hacer_peticion_api);
  </script>
</html>
